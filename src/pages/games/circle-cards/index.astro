---
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards • Games • {SITE_NAME}</title>
    <meta name="description" content="Create or join a Circle Cards room." />
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <main class="wrap" data-api={API_URL}>
      <header class="hero">
        <h1>Circle Cards</h1>
        <p class="lead">
          Create a room, share the link, and play. The black card is drawn inside the room.
        </p>
      </header>

      <section class="grid2">
        <!-- Create -->
        <section class="card">
          <h2>Create a Room</h2>
          <p class="muted small">Makes a new room instantly and sends you in as host.</p>

          <button id="create" class="btn primary">Create Room</button>
          <p id="createOut" class="muted small"></p>

          <p class="tiny muted">
            API in use: <span class="mono">{API_URL}</span>
          </p>
        </section>

        <!-- Join -->
        <section class="card">
          <h2>Join a Room</h2>
          <p class="muted small">Got a room code? Paste it here.</p>

          <label class="label" for="roomId">Room ID</label>
          <input id="roomId" placeholder="e.g. 7zwio30" autocomplete="off" />

          <button id="join" class="btn">Join Room</button>
          <p id="joinOut" class="muted small"></p>
        </section>
      </section>
    </main>

    <script>
      const root = document.querySelector("main.wrap");
      const API = (root?.dataset?.api || "").replace(/\/+$/, "");

      const createOut = document.getElementById("createOut");
      const joinOut = document.getElementById("joinOut");
      const roomIdEl = document.getElementById("roomId");

      // Create room: NEW worker should NOT require a prompt here.
      document.getElementById("create").onclick = async () => {
        if (!API) {
          createOut.textContent = "Missing API URL (PUBLIC_CC_API).";
          return;
        }

        createOut.textContent = "Creating room…";

        let r;
        try {
          // If your worker expects a body, you can change body to "{}"
          r = await fetch(API + "/api/rooms", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: "{}",
          });
        } catch (e) {
          createOut.textContent = "Network error: " + (e?.message || e);
          return;
        }

        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}

        if (!r.ok) {
          createOut.textContent = data.error || `Failed (${r.status}): ${text.slice(0, 200)}`;
          return;
        }

        if (!data.roomId) {
          createOut.textContent = "Created, but response missing roomId.";
          return;
        }

        // Save host token if provided
        if (data.hostToken) localStorage.setItem("cc_host_" + data.roomId, data.hostToken);

        location.href = "/games/circle-cards/" + data.roomId;
      };

      // Join room: just navigate to /games/circle-cards/:id
      document.getElementById("join").onclick = () => {
        const id = (roomIdEl.value || "").trim();
        if (!id) {
          joinOut.textContent = "Enter a Room ID.";
          return;
        }
        joinOut.textContent = "";
        location.href = "/games/circle-cards/" + encodeURIComponent(id);
      };

      roomIdEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("join").click();
      });
    </script>

    <style>
      body{ margin:0; font-family:system-ui; background:#070a0f; color:#fff; }
      .wrap{ max-width:980px; margin:40px auto; padding:0 18px; }

      .hero{ margin-bottom:18px; }
      h1{ margin:0 0 6px; font-size:40px; }
      .lead{ color:rgba(255,255,255,.72); max-width:75ch; margin:0; }

      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

      .card{
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.06);
        border-radius:18px;
        padding:18px;
      }

      h2{ margin:0 0 8px; font-size:18px; }
      .label{ font-weight:800; display:block; margin:12px 0 8px; font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.65); }

      input{
        width:100%;
        box-sizing:border-box;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
      }

      .btn{
        margin-top:12px;
        padding:12px 18px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
      }

      .btn.primary{
        border-color:rgba(9,255,3,.55);
        background:rgba(9,255,3,.14);
      }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:12px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

      @media (max-width: 900px){
        .grid2{ grid-template-columns:1fr; }
        h1{ font-size:34px; }
      }
    </style>
  </body>
</html>
