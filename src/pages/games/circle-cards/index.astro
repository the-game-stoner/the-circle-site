---
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards • Games • {SITE_NAME}</title>
    <meta name="description" content="Create a Circle Cards room and play together. Async-friendly party game." />
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <div class="page">
      <!-- Top Nav (matches your site style) -->
      <header class="top">
        <div class="container nav">
          <a class="brand" href="/" aria-label={`${SITE_NAME} Home`}>
            <img src="/favicon.png" alt="" class="logo" />
            <span class="name">{SITE_NAME}</span>
          </a>

          <nav class="links" aria-label="Primary">
            <a href="/discord" class="navLink">Discord</a>
            <a href="/league" class="navLink">League</a>
            <a href="/music" class="navLink">Music</a>
            <a href="/games" class="navLink active">Games</a>
            <a href="/blog" class="navLink">Blog</a>
          </nav>

          <details class="menu">
            <summary class="menuBtn" aria-label="Open menu">
              <span class="menuIcon" aria-hidden="true"></span>
            </summary>
            <div class="menuPanel" role="menu">
              <a href="/discord" role="menuitem">Discord</a>
              <a href="/league" role="menuitem">League</a>
              <a href="/music" role="menuitem">Music</a>
              <a href="/games" role="menuitem">Games</a>
              <a href="/blog" role="menuitem">Blog</a>
            </div>
          </details>
        </div>
      </header>

      <main class="wrap">
        <header class="hero">
          <div class="topline">
            <h1>Circle Cards</h1>
            <a class="back muted" href="/games">← Games</a>
          </div>

          <p class="lead">
            A Cards Against Humanity–style party game built for async play.
            Create a room, share the link, let chaos happen.
          </p>
        </header>

        <section class="card">
          <label for="prompt">Prompt (black card)</label>
          <textarea
            id="prompt"
            placeholder="The worst thing to say in voice chat is: _______"
          ></textarea>

          <button id="create" class="btn primary">Create Room</button>
          <p id="out" class="muted small"></p>

          <p class="tiny muted">
            API in use: <span class="mono">{API_URL}</span>
          </p>
        </section>
      </main>
    </div>

    <!-- ✅ Correct Astro-safe variable injection -->
    <script define:vars={{ API_URL }}>
      const API = String(API_URL || "").replace(/\/+$/, "");
      const out = document.getElementById("out");
      const promptEl = document.getElementById("prompt");

      async function readJson(r) {
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { text, data };
      }

      document.getElementById("create").onclick = async () => {
        out.textContent = "";
        const prompt = promptEl.value.trim();
        if (!prompt) {
          out.textContent = "Enter a prompt first.";
          return;
        }

        out.textContent = "Creating room…";

        let r;
        try {
          r = await fetch(API + "/api/rooms", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ prompt }),
          });
        } catch (e) {
          out.textContent = "Network error: " + (e?.message || e);
          return;
        }

        const { text, data } = await readJson(r);

        if (!r.ok) {
          out.textContent = data.error || `Failed (${r.status}): ${text.slice(0, 220)}`;
          return;
        }

        localStorage.setItem("cc_host_" + data.roomId, data.hostToken);
        location.href = "/games/circle-cards/" + data.roomId;
      };
    </script>

    <style>
      :root{
        --bg:#070a0f;
        --panel: rgba(255,255,255,.06);
        --border: rgba(255,255,255,.12);
        --text: rgba(255,255,255,.92);
        --muted: rgba(255,255,255,.68);
        --muted2: rgba(255,255,255,.55);
        --accent:#09ff03;
        --focus: 0 0 0 3px rgba(9,255,3,0.25);
      }

      *{ box-sizing:border-box; }
      body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
      a{ color:inherit; text-decoration:none; }

      /* Top nav */
      .top{
        position: sticky; top: 0; z-index: 10;
        backdrop-filter: blur(12px);
        background: rgba(7,10,15,.65);
        border-bottom: 1px solid rgba(255,255,255,.10);
      }
      .container{ max-width:1060px; margin:0 auto; padding:0 18px; }
      .nav{ display:flex; align-items:center; justify-content:space-between; padding:14px 0; gap:14px; }
      .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:-0.02em; }
      .logo{ width:30px; height:30px; display:block; filter: drop-shadow(0 0 10px rgba(9,255,3,0.18)); }
      .name{ font-size:15px; opacity:.95; }

      .links{ display:flex; gap:16px; align-items:center; }
      .navLink{
        color: rgba(255,255,255,0.80);
        font-size:14px;
        padding: 8px 8px;
        border-radius: 12px;
      }
      .navLink:hover{ color: rgba(255,255,255,0.96); background: rgba(255,255,255,0.06); }
      .navLink.active{ color: rgba(255,255,255,0.96); background: rgba(255,255,255,0.06); }
      .navLink:focus-visible{ outline:none; box-shadow: var(--focus); }

      /* Mobile menu */
      .menu{ display:none; position:relative; }
      .menuBtn{
        list-style:none; cursor:pointer; user-select:none;
        width:44px; height:44px; border-radius:14px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04);
        display:grid; place-items:center;
      }
      .menuBtn::-webkit-details-marker{ display:none; }
      .menuIcon{ width:18px; height:2px; background: rgba(255,255,255,.85); position:relative; border-radius:999px; }
      .menuIcon::before,.menuIcon::after{
        content:""; position:absolute; left:0; width:18px; height:2px;
        background: rgba(255,255,255,.85); border-radius:999px;
      }
      .menuIcon::before{ top:-6px; } .menuIcon::after{ top:6px; }
      .menuPanel{
        position:absolute; right:0; top:56px; width:220px;
        padding:10px; border-radius:16px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(7,10,15,.92);
        box-shadow: 0 18px 44px rgba(0,0,0,.35);
      }
      .menuPanel a{ display:block; padding:10px; border-radius:12px; color: rgba(255,255,255,.86); }
      .menuPanel a:hover{ background: rgba(255,255,255,.06); color: rgba(255,255,255,.96); }

      /* Page */
      .page{ min-height:100vh; }
      .wrap{ max-width:820px; margin:40px auto; padding:0 18px; }

      .hero{ margin-bottom:22px; }
      .topline{ display:flex; justify-content:space-between; gap:12px; align-items:flex-end; flex-wrap:wrap; }
      h1{ margin:0 0 6px; font-size:40px; }
      .lead{ color:rgba(255,255,255,.72); max-width:70ch; margin:0; }

      .card{
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.06);
        border-radius:18px;
        padding:18px;
      }

      label{ font-weight:800; display:block; margin-bottom:8px; }
      textarea{
        width:100%;
        box-sizing:border-box;
        min-height:110px;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
        resize:vertical;
      }

      .btn{
        margin-top:12px;
        padding:12px 18px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
      }
      .btn.primary{ border-color:rgba(9,255,3,.55); background:rgba(9,255,3,.14); }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:10px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .back{ color: rgba(255,255,255,.75); }

      @media (max-width: 820px){
        .links{ display:none; }
        .menu{ display:block; }
      }
    </style>
  </body>
</html>
