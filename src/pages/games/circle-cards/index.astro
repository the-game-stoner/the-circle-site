---
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards ‚Ä¢ Games ‚Ä¢ {SITE_NAME}</title>
    <meta name="description" content="Create or join a Circle Cards room." />
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <main class="wrap">
      <header class="hero">
        <h1>Circle Cards</h1>
        <p class="lead">Pick a username, join an open room, or create your own.</p>
        <div class="muted tiny">API: <span class="mono">{API_URL}</span></div>
      </header>

      <section class="grid2">
        <section class="card">
          <h2>Your username</h2>
          <div class="muted small">Must be globally unique.</div>

          <input id="uname" placeholder="Username (ex: TGS)" />
          <button id="login" class="btn primary">Login</button>
          <button id="logout" class="btn ghost">Logout</button>

          <div id="loginOut" class="muted small"></div>
        </section>

        <section class="card">
          <h2>Create a room</h2>

          <input id="roomName" placeholder="Room name (ex: After Hours)" />
          <div class="gridMini">
            <div>
              <label class="lbl">Points to win</label>
              <input id="points" type="number" min="1" max="25" value="7" />
            </div>
            <div>
              <label class="lbl">Max players</label>
              <input id="max" type="number" min="4" max="20" value="10" />
            </div>
          </div>

          <label class="lbl">Password (optional)</label>
          <input id="pass" placeholder="Leave blank for public room" />

          <div class="deckRow">
            <label class="chk"><input type="checkbox" id="deckBase" checked /> Base</label>
            <label class="chk"><input type="checkbox" id="deckSavage" /> Savage</label>
          </div>

          <button id="create" class="btn primary">Create Room</button>
          <div id="createOut" class="muted small"></div>
        </section>
      </section>

      <section class="card">
        <div class="row">
          <h2>Open rooms</h2>
          <button id="refresh" class="btn ghost">Refresh</button>
        </div>

        <div id="rooms" class="rooms"></div>
        <div id="roomsOut" class="muted small"></div>
      </section>
    </main>

    <script>
      const API = "{API_URL}";

      let userToken = localStorage.getItem("cc_userToken") || "";
      let userName = localStorage.getItem("cc_userName") || "";

      const elLoginOut = document.getElementById("loginOut");
      const elCreateOut = document.getElementById("createOut");
      const elRooms = document.getElementById("rooms");
      const elRoomsOut = document.getElementById("roomsOut");

      const uname = document.getElementById("uname");

      function authHeaders() {
        const h = { "content-type": "application/json" };
        if (userToken) h.authorization = "Bearer " + userToken;
        return h;
      }

      async function apiGET(path) {
        const r = await fetch(API + path, { headers: authHeaders() });
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      async function apiPOST(path, body) {
        const r = await fetch(API + path, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify(body || {}),
        });
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      function setLoggedInUI() {
        uname.value = userName || "";
        elLoginOut.textContent = userToken ? `Logged in as ${userName}` : "Not logged in.";
      }

      async function login() {
        const name = (uname.value || "").trim();
        if (!name) { elLoginOut.textContent = "Enter a username."; return; }
        elLoginOut.textContent = "Logging in‚Ä¶";

        const res = await apiPOST("/api/login", { name });
        if (!res.ok) {
          elLoginOut.textContent = res.data.error || `Login failed (${res.status})`;
          return;
        }

        userToken = res.data.userToken;
        userName = res.data.name;

        localStorage.setItem("cc_userToken", userToken);
        localStorage.setItem("cc_userName", userName);

        setLoggedInUI();
        loadRooms();
      }

      function logout() {
        userToken = "";
        userName = "";
        localStorage.removeItem("cc_userToken");
        localStorage.removeItem("cc_userName");
        setLoggedInUI();
      }

      async function createRoom() {
        if (!userToken) { elCreateOut.textContent = "Login first."; return; }

        const name = (document.getElementById("roomName").value || "").trim();
        const pointsToWin = Number(document.getElementById("points").value || 7);
        const maxPlayers = Number(document.getElementById("max").value || 10);
        const password = (document.getElementById("pass").value || "").trim();

        const decks = [];
        if (document.getElementById("deckBase").checked) decks.push("base");
        if (document.getElementById("deckSavage").checked) decks.push("savage");

        elCreateOut.textContent = "Creating‚Ä¶";

        const res = await apiPOST("/api/rooms", { name, pointsToWin, maxPlayers, password, decks });
        if (!res.ok) {
          elCreateOut.textContent = res.data.error || `Create failed (${res.status})`;
          return;
        }

        // hostToken exists if you want host-only actions later; store it like before
        localStorage.setItem("cc_host_" + res.data.roomId, res.data.hostToken);

        // go to room
        location.href = "/games/circle-cards/" + res.data.roomId;
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m =>
          ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
        );
      }

      function renderRooms(list) {
        elRooms.innerHTML = "";
        if (!Array.isArray(list) || !list.length) {
          elRooms.innerHTML = `<div class="muted small">No open rooms right now.</div>`;
          return;
        }

        list.forEach(r => {
          const locked = r.isLocked ? "üîí" : "üåê";
          const div = document.createElement("div");
          div.className = "roomRow";
          div.innerHTML = `
            <div class="roomMain">
              <div class="roomName">${locked} <b>${escapeHtml(r.name || r.id)}</b></div>
              <div class="muted small">
                ${escapeHtml(r.phase || "‚Äî").toUpperCase()} ‚Ä¢ Players ${r.playerCount}/${r.maxPlayers} ‚Ä¢
                First to ${r.pointsToWin} ‚Ä¢ Decks: ${(r.decks || []).join(", ")}
              </div>
            </div>
            <div class="roomBtns">
              <a class="btn primary" href="/games/circle-cards/${r.id}">Join</a>
            </div>
          `;
          elRooms.appendChild(div);
        });
      }

      async function loadRooms() {
        elRoomsOut.textContent = "Loading rooms‚Ä¶";
        const res = await apiGET("/api/rooms");
        if (!res.ok) {
          elRoomsOut.textContent = res.data.error || `Rooms failed (${res.status})`;
          return;
        }
        renderRooms(res.data.rooms || []);
        elRoomsOut.textContent = "Updated.";
      }

      document.getElementById("login").onclick = login;
      document.getElementById("logout").onclick = logout;
      document.getElementById("create").onclick = createRoom;
      document.getElementById("refresh").onclick = loadRooms;

      setLoggedInUI();
      loadRooms();
      setInterval(loadRooms, 8000);
    </script>

    <style>
      body{ margin:0; font-family:system-ui; background:#070a0f; color:#fff; }
      .wrap{ max-width:1100px; margin:30px auto; padding:0 18px; }
      .hero{ margin-bottom:16px; }
      h1{ margin:0 0 6px; font-size:40px; }
      .lead{ color:rgba(255,255,255,.72); max-width:70ch; margin: 0 0 8px; }

      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

      .card{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:18px; border-radius:16px; margin:14px 0; }
      .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      h2{ margin:0 0 10px; font-size:18px; }

      input{
        width:100%;
        box-sizing:border-box;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
        margin-top:10px;
      }

      .gridMini{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:10px;
        margin-top: 10px;
      }
      .lbl{ display:block; margin-top:10px; font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.65); font-weight:800; }

      .deckRow{ display:flex; gap:14px; flex-wrap:wrap; margin-top:12px; }
      .chk{ display:flex; gap:8px; align-items:center; font-weight:800; }

      .rooms{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
      .roomRow{
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.04);
        border-radius:14px;
        padding:12px;
        display:flex;
        justify-content:space-between;
        gap:12px;
        flex-wrap:wrap;
      }
      .roomName{ font-size:16px; }

      .btn{
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        text-decoration:none;
      }
      .btn.primary{ border-color:rgba(9,255,3,.55); background:rgba(9,255,3,.14); }
      .btn.ghost{ background:rgba(255,255,255,.04); }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:10px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

      @media(max-width:900px){
        .grid2{ grid-template-columns:1fr; }
        h1{ font-size:34px; }
      }
    </style>
  </body>
</html>
