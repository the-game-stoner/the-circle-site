---
const { id } = Astro.params;
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards • Room {id} • {SITE_NAME}</title>
    <meta name="description" content="Play Circle Cards — a CAH-style party game for your Discord crew." />
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <main class="wrap">
      <div class="topline">
        <div>
          <h1>Circle Cards <span class="muted">• Room {id}</span></h1>
          <div class="muted small" id="status">Loading…</div>
        </div>
        <div class="topBtns">
          <a class="btn ghost" href="/games/circle-cards">New Room</a>
          <button class="btn ghost" id="copy">Copy Link</button>
        </div>
      </div>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">Black Card</div>
            <div id="black" class="black">Loading…</div>
          </div>
          <div class="meta">
            <div class="chip" id="phase">…</div>
            <div class="muted small" id="czar">Czar: …</div>
            <div class="muted small" id="players">Players: …</div>
          </div>
        </div>

        <div class="warn" id="minPlayers" style="display:none;">
          Need <b>4+</b> players to play for real. Share the link and wait for the squad.
        </div>
      </section>

      <section class="grid2">
        <section class="card">
          <div class="row">
            <h2>Your seat</h2>
            <span class="muted small" id="me">—</span>
          </div>

          <input id="name" placeholder="Nickname" />
          <button id="join" class="btn primary">Join Room</button>
          <div id="joinOut" class="muted small"></div>

          <p class="tiny muted">
            API in use: <span class="mono">{API_URL}</span>
          </p>
        </section>

        <section class="card">
          <div class="row">
            <h2>Scoreboard</h2>
          </div>
          <div id="scores" class="scores muted small">—</div>
        </section>
      </section>

      <section class="card">
        <div class="row">
          <h2>Your hand (7)</h2>
          <span class="muted small" id="handHint">Join the room to get dealt in.</span>
        </div>
        <div id="hand" class="handGrid"></div>
        <div id="submitOut" class="muted small"></div>
      </section>

      <section class="card" id="judgeCard" style="display:none;">
        <div class="row">
          <h2>Czar picks the winner</h2>
          <span class="chip">Judge</span>
        </div>
        <div id="submissions" class="handGrid"></div>
        <div id="judgeOut" class="muted small"></div>
      </section>
    </main>

    <script>
      const ROOM = "{id}";
      const API = "{API_URL}";

      // identity per room
      let playerToken = localStorage.getItem("cc_playerToken_" + ROOM) || "";
      let playerId = localStorage.getItem("cc_playerId_" + ROOM) || "";

      const elStatus = document.getElementById("status");
      const elBlack = document.getElementById("black");
      const elPhase = document.getElementById("phase");
      const elCzar = document.getElementById("czar");
      const elPlayers = document.getElementById("players");
      const elScores = document.getElementById("scores");
      const elHand = document.getElementById("hand");
      const elHandHint = document.getElementById("handHint");
      const elSubmitOut = document.getElementById("submitOut");
      const elMe = document.getElementById("me");
      const elMinPlayers = document.getElementById("minPlayers");

      const elJoinOut = document.getElementById("joinOut");
      const elJudgeCard = document.getElementById("judgeCard");
      const elSubs = document.getElementById("submissions");
      const elJudgeOut = document.getElementById("judgeOut");

      const nameInput = document.getElementById("name");
      const joinBtn = document.getElementById("join");

      // remember nickname
      nameInput.value = localStorage.getItem("cc_name") || "";

      document.getElementById("copy").onclick = async () => {
        try {
          await navigator.clipboard.writeText(location.href);
          elStatus.textContent = "Link copied ✅";
        } catch {
          elStatus.textContent = "Couldn’t copy. Just copy the URL.";
        }
      };

      function headers() {
        const h = { "content-type": "application/json" };
        if (playerToken) h.authorization = "Bearer " + playerToken;
        return h;
      }

      async function apiGET(path) {
        let r;
        try {
          r = await fetch(API + path, { headers: headers() });
        } catch (e) {
          return { ok: false, status: 0, data: { error: "Network error" }, text: String(e?.message || e) };
        }
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      async function apiPOST(path, body) {
        let r;
        try {
          r = await fetch(API + path, {
            method: "POST",
            headers: headers(),
            body: JSON.stringify(body || {}),
          });
        } catch (e) {
          return { ok: false, status: 0, data: { error: "Network error" }, text: String(e?.message || e) };
        }
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      function renderScores(scores) {
        if (!scores) { elScores.textContent = "—"; return; }

        let rows = [];
        if (Array.isArray(scores)) rows = scores;
        else rows = Object.entries(scores).map(([name, points]) => ({ name, points }));

        rows.sort((a,b) => (b.points||0) - (a.points||0));
        if (!rows.length) { elScores.textContent = "No points yet."; return; }

        elScores.innerHTML = rows
          .map(s => `<div class="scoreRow"><span>${escapeHtml(s.name)}</span><b>${s.points||0}</b></div>`)
          .join("");
      }

      function clearHand() { elHand.innerHTML = ""; }
      function clearSubs() { elSubs.innerHTML = ""; }

      // Hand supports:
      // - ["text", ...]
      // - [{ cardId, text }, ...]
      function renderHand(hand, canPlay) {
        clearHand();

        if (!Array.isArray(hand) || !hand.length) {
          elHand.innerHTML = `<div class="muted small">No hand yet. Join the room.</div>`;
          return;
        }

        hand.forEach((entry) => {
          const cardId = (entry && typeof entry === "object") ? entry.cardId : null;
          const text = (entry && typeof entry === "object") ? (entry.text || "") : String(entry);

          const btn = document.createElement("button");
          btn.className = "whiteCard";
          btn.innerHTML = `<div class="cardText">${escapeHtml(text)}</div>`;
          btn.disabled = !canPlay;

          btn.onclick = () => submitCard({ cardId, text });
          elHand.appendChild(btn);
        });
      }

      function renderJudge(subs, canJudge) {
        clearSubs();
        if (!Array.isArray(subs) || !subs.length) {
          elSubs.innerHTML = `<div class="muted small">Waiting for submissions…</div>`;
          return;
        }

        subs.forEach((s) => {
          const btn = document.createElement("button");
          btn.className = "whiteCard";
          btn.innerHTML = `<div class="cardText">${escapeHtml(s.text || "")}</div>`;
          btn.disabled = !canJudge;
          btn.onclick = () => judgePick(s.submissionId);
          elSubs.appendChild(btn);
        });
      }

      async function join() {
        const name = (nameInput.value || "").trim() || "Anonymous";
        localStorage.setItem("cc_name", name);

        elJoinOut.textContent = "Joining…";
        const res = await apiPOST(`/api/rooms/${ROOM}/join`, { name });

        if (!res.ok) {
          elJoinOut.textContent = res.data.error || `Join failed (${res.status}): ${res.text.slice(0, 160)}`;
          return;
        }

        playerToken = res.data.playerToken || "";
        playerId = res.data.playerId || "";
        localStorage.setItem("cc_playerToken_" + ROOM, playerToken);
        localStorage.setItem("cc_playerId_" + ROOM, playerId);

        elJoinOut.textContent = "Joined ✅";
        load();
      }

      async function submitCard({ cardId, text }) {
        if (!playerToken) { elSubmitOut.textContent = "Join first."; return; }

        elSubmitOut.textContent = "Submitting…";

        // Prefer cardId, fallback to text
        const body = (cardId !== null && cardId !== undefined)
          ? { cardId }
          : { text };

        const res = await apiPOST(`/api/rooms/${ROOM}/submit`, body);

        if (!res.ok) {
          elSubmitOut.textContent = res.data.error || `Submit failed (${res.status}): ${res.text.slice(0, 180)}`;
          return;
        }

        elSubmitOut.textContent = "Submitted ✅";
        load();
      }

      async function judgePick(submissionId) {
        elJudgeOut.textContent = "Picking…";
        const res = await apiPOST(`/api/rooms/${ROOM}/judge`, { submissionId });

        if (!res.ok) {
          elJudgeOut.textContent = res.data.error || `Judge failed (${res.status}): ${res.text.slice(0, 180)}`;
          return;
        }

        elJudgeOut.textContent = "Winner picked ✅";
        load();
      }

      async function load() {
        const res = await apiGET(`/api/rooms/${ROOM}`);
        if (!res.ok) {
          elStatus.textContent = res.data.error || `Room load failed (${res.status}): ${res.text.slice(0, 160)}`;
          elBlack.textContent = "—";
          return;
        }

        const room = res.data;

        const phase = room.phase || "unknown";
        elPhase.textContent = String(phase).toUpperCase();

        elBlack.textContent = room.blackCard || "—";
        elCzar.textContent = "Czar: " + (room.czarName || "—");
        elPlayers.textContent = "Players: " + (room.playerCount ?? 0);

        const count = room.playerCount ?? 0;
        elMinPlayers.style.display = (count < 4) ? "block" : "none";

        const me = room.me || {};
        const joined = !!me.name;

        elMe.textContent = joined
          ? `${me.name}${me.isCzar ? " (Czar)" : ""}`
          : "Not joined";

        renderScores(room.scores);

        // UI enable/disable
        joinBtn.disabled = joined;
        nameInput.disabled = joined;

        if (!joined) {
          elHandHint.textContent = "Join the room to get dealt in.";
        } else if (me.isCzar) {
          elHandHint.textContent = "You’re the czar. You don’t play a card this round.";
        } else if (me.hasSubmitted) {
          elHandHint.textContent = "You already submitted. Waiting on others…";
        } else if (count < 4) {
          elHandHint.textContent = "Waiting for at least 4 players…";
        } else if (phase !== "playing") {
          elHandHint.textContent = "Not accepting submissions yet…";
        } else {
          elHandHint.textContent = "Click a card to submit.";
        }

        const canPlay =
          joined &&
          !!playerToken &&
          !me.isCzar &&
          !me.hasSubmitted &&
          count >= 4 &&
          phase === "playing";

        renderHand(room.hand, canPlay);

        const canJudge =
          joined &&
          !!playerToken &&
          !!me.isCzar &&
          phase === "judging";

        elJudgeCard.style.display = (joined && me.isCzar) ? "block" : "none";
        if (joined && me.isCzar) renderJudge(room.submissions, canJudge);

        elStatus.textContent = "Updated.";
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (m) =>
          ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
        );
      }

      joinBtn.onclick = join;

      load();
      setInterval(load, 2500);
    </script>

    <style>
      body{ margin:0; font-family:system-ui; background:#070a0f; color:#fff; }
      .wrap{ max-width:1100px; margin:30px auto; padding:0 18px; }

      .topline{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end; }
      .topBtns{ display:flex; gap:10px; flex-wrap:wrap; }

      .card{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:18px; border-radius:16px; margin:14px 0; }
      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

      .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      h1{ margin:0; }
      h2{ margin:0; font-size:18px; }

      .label{ font-weight:800; font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.65); }
      .black{
        margin-top: 8px;
        font-size: 20px;
        line-height: 1.35;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(0,0,0,.35);
      }

      .meta{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; min-width: 200px; }
      .warn{
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255,170,120,.28);
        background: rgba(255,170,120,.10);
        color: rgba(255,255,255,.92);
        font-size: 13px;
      }

      input{
        width:100%;
        box-sizing:border-box;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
        margin-top:10px;
      }

      .scores{ margin-top: 10px; display:flex; flex-direction:column; gap:6px; }
      .scoreRow{ display:flex; justify-content:space-between; gap:10px; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }

      .handGrid{
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(3, minmax(0,1fr));
        gap: 10px;
      }

      .whiteCard{
        text-align:left;
        cursor:pointer;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        padding: 12px;
        color:#fff;
        font-weight:700;
      }
      .whiteCard:hover{ border-color: rgba(9,255,3,.35); }
      .whiteCard:disabled{
        opacity:.55;
        cursor:not-allowed;
        border-color: rgba(255,255,255,.12);
      }
      .cardText{ font-weight:700; line-height:1.35; }

      .btn{
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .btn.primary{ border-color:rgba(9,255,3,.55); background:rgba(9,255,3,.14); }
      .btn.ghost{ background:rgba(255,255,255,.04); }

      .chip{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); font-size:12px; width: fit-content; }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:12px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

      @media(max-width:900px){
        .grid2{ grid-template-columns:1fr; }
        .handGrid{ grid-template-columns: 1fr; }
        .meta{ align-items:flex-start; }
      }
    </style>
  </body>
</html>
