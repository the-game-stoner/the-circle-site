---
const { id } = Astro.params;
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards • Room {id} • {SITE_NAME}</title>
    <meta name="description" content={`Circle Cards room ${id} on The-Circle.`} />
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <header class="top">
      <div class="container nav">
        <a class="brand" href="/" aria-label={`${SITE_NAME} Home`}>
          <img src="/favicon.png" alt="" class="logo" />
          <span class="name">{SITE_NAME}</span>
        </a>

        <nav class="links" aria-label="Primary">
          <a href="/discord" class="navLink">Discord</a>
          <a href="/league" class="navLink">League</a>
          <a href="/music" class="navLink">Music</a>
          <a href="/games" class="navLink">Games</a>
          <a href="/blog" class="navLink">Blog</a>
        </nav>
      </div>
    </header>

    <main class="wrap">
      <div class="topline">
        <h1>Circle Cards <span class="muted">• Room {id}</span></h1>
        <a class="back" href="/games/circle-cards">New Room</a>
      </div>

      <section class="card">
        <div class="label">Prompt</div>
        <div id="prompt" class="prompt">Loading…</div>

        <div class="controls">
          <button id="reveal" class="btn ghost">Reveal</button>
          <button id="next" class="btn ghost">Next Round</button>
        </div>

        <p class="tiny muted">
          API in use: <span class="mono">{API_URL}</span>
        </p>
      </section>

      <section class="grid2">
        <div class="card">
          <h2>Join</h2>
          <input id="name" placeholder="Nickname (optional)" />
          <button id="join" class="btn primary">Join</button>
          <div id="me" class="muted small"></div>
        </div>

        <div class="card">
          <h2>Submit</h2>
          <textarea id="text" placeholder="Your answer…"></textarea>
          <button id="submit" class="btn primary">Submit</button>
          <div id="submitOut" class="muted small"></div>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <h2>Revealed Cards</h2>
          <span id="state" class="chip">…</span>
        </div>
        <div id="cards" class="grid"></div>
        <div id="voteOut" class="muted small"></div>
      </section>

      <section class="card">
        <h2>Winners</h2>
        <div id="winners" class="muted"></div>
      </section>
    </main>

    <script>
      const ROOM = "{id}";
      const API = "{API_URL}";

      let playerToken = localStorage.getItem("cc_playerToken_" + ROOM) || "";
      let hostToken = localStorage.getItem("cc_host_" + ROOM) || "";

      const elPrompt = document.getElementById("prompt");
      const elCards = document.getElementById("cards");
      const elWinners = document.getElementById("winners");
      const elState = document.getElementById("state");
      const me = document.getElementById("me");

      function headers() {
        const h = { "content-type": "application/json" };
        if (playerToken) h.authorization = "Bearer " + playerToken;
        if (hostToken) h["x-host-token"] = hostToken;
        return h;
      }

      async function safeJson(r) {
        const text = await r.text();
        try { return { ok: r.ok, status: r.status, data: JSON.parse(text), text }; }
        catch { return { ok: r.ok, status: r.status, data: {}, text }; }
      }

      async function load() {
        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM);
        } catch (e) {
          elPrompt.textContent = "Network error: " + (e?.message || e);
          elState.textContent = "ERROR";
          elCards.innerHTML = `<div class="muted">Unable to load room (network).</div>`;
          return;
        }

        const { ok, status, data, text } = await safeJson(r);
        if (!ok) {
          elPrompt.textContent = data.error || `Failed (${status}): ${text.slice(0, 200)}`;
          elState.textContent = "ERROR";
          elCards.innerHTML = `<div class="muted">Unable to load room.</div>`;
          return;
        }

        elPrompt.textContent = data.prompt;
        elState.textContent = (data.state || "unknown").toUpperCase();
        renderWinners(data.winners || []);
        renderCards(data);
      }

      function renderWinners(winners) {
        if (!winners.length) { elWinners.textContent = "No winners yet."; return; }
        elWinners.innerHTML = winners
          .slice(-10).reverse()
          .map(w => `<div>Round ${w.round}: <b>${escapeHtml(w.text)}</b> (${w.votes} votes)</div>`)
          .join("");
      }

      function renderCards(room) {
        elCards.innerHTML = "";

        if (room.state !== "voting") {
          elCards.innerHTML = `<div class="muted">Waiting for reveal.</div>`;
          return;
        }

        const list = Array.isArray(room.revealedOrder) ? room.revealedOrder : [];
        if (!list.length) {
          elCards.innerHTML = `<div class="muted">No cards revealed yet.</div>`;
          return;
        }

        list.forEach(c => {
          const votes = (room.votes && room.votes[c.submissionId]) ? room.votes[c.submissionId] : 0;
          const div = document.createElement("div");
          div.className = "tile";
          div.innerHTML = `
            <div>${escapeHtml(c.text)}</div>
            <button class="btn primary">Vote</button>
            <div class="muted small">Votes: ${votes}</div>
          `;
          div.querySelector("button").onclick = () => vote(c.submissionId);
          elCards.appendChild(div);
        });
      }

      async function join() {
        const name = document.getElementById("name").value;

        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM + "/join", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify({ name }),
          });
        } catch (e) {
          me.textContent = "Network error: " + (e?.message || e);
          return;
        }

        const { ok, status, data, text } = await safeJson(r);
        if (!ok) { me.textContent = data.error || `Join failed (${status}): ${text.slice(0, 200)}`; return; }

        playerToken = data.playerToken;
        localStorage.setItem("cc_playerToken_" + ROOM, playerToken);
        me.textContent = "Joined as " + data.name;
        load();
      }

      async function submit() {
        const textVal = document.getElementById("text").value;
        const out = document.getElementById("submitOut");
        if (!playerToken) { out.textContent = "Join first."; return; }

        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM + "/submit", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify({ text: textVal }),
          });
        } catch (e) {
          out.textContent = "Network error: " + (e?.message || e);
          return;
        }

        const { ok, status, data, text } = await safeJson(r);
        out.textContent = ok ? "Submitted ✅" : (data.error || `Submit failed (${status}): ${text.slice(0, 200)}`);
        load();
      }

      async function vote(submissionId) {
        const out = document.getElementById("voteOut");
        if (!playerToken) { out.textContent = "Join first."; return; }

        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM + "/vote", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify({ submissionId }),
          });
        } catch (e) {
          out.textContent = "Network error: " + (e?.message || e);
          return;
        }

        const { ok, status, data, text } = await safeJson(r);
        out.textContent = ok ? "Voted ✅" : (data.error || `Vote failed (${status}): ${text.slice(0, 200)}`);
        load();
      }

      async function reveal() {
        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM + "/reveal", { method: "POST", headers: headers() });
        } catch {
          alert("Network error during reveal.");
          return;
        }
        const { ok, status, data, text } = await safeJson(r);
        if (!ok) alert(data.error || `Reveal failed (${status}): ${text.slice(0, 200)}`);
        load();
      }

      async function nextRound() {
        const promptText = prompt("Next prompt:");
        if (!promptText) return;

        let r;
        try {
          r = await fetch(API + "/api/rooms/" + ROOM + "/next", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify({ prompt: promptText }),
          });
        } catch {
          alert("Network error during next round.");
          return;
        }
        const { ok, status, data, text } = await safeJson(r);
        if (!ok) alert(data.error || `Next round failed (${status}): ${text.slice(0, 200)}`);
        load();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m =>
          ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
        );
      }

      document.getElementById("join").onclick = join;
      document.getElementById("submit").onclick = submit;
      document.getElementById("reveal").onclick = reveal;
      document.getElementById("next").onclick = nextRound;

      load();
      setInterval(load, 3000);
    </script>

    <style>
      :root{
        --bg:#070a0f;
        --panel:rgba(255,255,255,.06);
        --panel2:rgba(255,255,255,.04);
        --border:rgba(255,255,255,.12);
        --text:rgba(255,255,255,.92);
        --muted:rgba(255,255,255,.68);
        --muted2:rgba(255,255,255,.55);
        --accent:#09ff03;
        --shadow:0 18px 44px rgba(0,0,0,.35);
      }
      *{ box-sizing:border-box; }
      body{ margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }

      .top{
        position:sticky; top:0; z-index:10;
        backdrop-filter:blur(12px);
        background:rgba(7,10,15,.65);
        border-bottom:1px solid rgba(255,255,255,.10);
      }
      .container{ max-width:1060px; margin:0 auto; padding:0 18px; }
      .nav{ display:flex; justify-content:space-between; align-items:center; gap:14px; padding:14px 0; }
      .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:-.02em; }
      .logo{ width:28px; height:28px; filter:drop-shadow(0 0 10px rgba(9,255,3,.18)); }
      .name{ font-size:15px; opacity:.95; }
      .links{ display:flex; gap:14px; font-size:14px; }
      .navLink{ color:rgba(255,255,255,.78); padding:8px 10px; border-radius:12px; }
      .navLink:hover{ color:rgba(255,255,255,.95); background:rgba(255,255,255,.06); }

      .wrap{ max-width:1100px; margin:26px auto; padding:0 18px; }

      .topline{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end; }
      .back{
        color:rgba(255,255,255,.80);
        border:1px solid rgba(255,255,255,.14);
        background:rgba(255,255,255,.04);
        padding:10px 12px;
        border-radius:12px;
      }
      .back:hover{ background:rgba(255,255,255,.06); color:rgba(255,255,255,.95); }

      .card{
        border:1px solid rgba(255,255,255,.12);
        background:var(--panel);
        padding:18px;
        border-radius:16px;
        margin:14px 0;
        box-shadow:var(--shadow);
      }
      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }

      .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }

      h1{ margin:0; }
      h2{ margin:0 0 10px; font-size:18px; }
      .label{ font-weight:800; font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.65); }
      .prompt{ font-size:18px; margin-top:6px; }

      textarea, input{
        width:100%;
        margin:10px 0 12px;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
      }
      textarea{ min-height:90px; }

      .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

      .tile{ border:1px solid rgba(255,255,255,.12); background:var(--panel2); border-radius:14px; padding:12px; }

      .btn{
        margin-top:8px;
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
      }
      .btn.primary{ border-color:rgba(9,255,3,.55); background:rgba(9,255,3,.14); }
      .btn.ghost{ background:rgba(255,255,255,.04); }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:12px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

      .chip{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); font-size:12px; }

      @media(max-width:900px){
        .grid,.grid2{ grid-template-columns:1fr; }
        .links{ display:none; }
      }
    </style>
  </body>
</html>
