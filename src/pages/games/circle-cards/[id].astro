---
const { id } = Astro.params;
const SITE_NAME = "The-Circle";
const API_BASE = import.meta.env.PUBLIC_CC_API;
const API_URL = (API_BASE || "https://circle-cards-api.thegamestoners.workers.dev").replace(/\/+$/, "");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Circle Cards • Room {id} • {SITE_NAME}</title>
    <link rel="icon" href="/favicon.png" type="image/png" />
  </head>

  <body>
    <main
      class="wrap"
      id="app"
      data-room={id}
      data-api={API_URL}
    >
      <div class="topline">
        <div>
          <h1>Circle Cards <span class="muted">• Room {id}</span></h1>
          <div class="muted small" id="status">Loading…</div>
        </div>
        <div class="topBtns">
          <a class="btn ghost" href="/games/circle-cards">New Room</a>
          <button class="btn ghost" id="copy">Copy Link</button>
        </div>
      </div>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">Black Card</div>
            <div id="black" class="black">Loading…</div>
          </div>
          <div class="meta">
            <div class="chip" id="phase">…</div>
            <div class="muted small" id="czar">Czar: …</div>
            <div class="muted small" id="players">Players: …</div>
          </div>
        </div>

        <div class="warn" id="minPlayers" style="display:none;">
          Need <b>4+</b> players to play for real. Share the link and wait for the squad.
        </div>
      </section>

      <section class="grid2">
        <section class="card">
          <div class="row">
            <h2>Your seat</h2>
            <span class="muted small" id="me">—</span>
          </div>

          <input id="name" placeholder="Nickname" />
          <button id="join" class="btn primary">Join Room</button>
          <div id="joinOut" class="muted small"></div>

          <p class="tiny muted">
            API in use: <span class="mono" id="apiText"></span>
          </p>
        </section>

        <section class="card">
          <div class="row">
            <h2>Scoreboard</h2>
          </div>
          <div id="scores" class="scores muted small">—</div>
        </section>
      </section>

      <section class="card">
        <div class="row">
          <h2>Your hand (7)</h2>
          <span class="muted small" id="handHint">Click a card to submit.</span>
        </div>
        <div id="hand" class="handGrid"></div>
        <div id="submitOut" class="muted small"></div>
      </section>

      <section class="card" id="judgeCard" style="display:none;">
        <div class="row">
          <h2>Czar picks the winner</h2>
          <span class="chip">Judge</span>
        </div>
        <div id="submissions" class="handGrid"></div>
        <div id="judgeOut" class="muted small"></div>
      </section>
    </main>

    <script>
      const app = document.getElementById("app");
      const ROOM = app.dataset.room;             // ✅ real room id
      const API = app.dataset.api.replace(/\/+$/, ""); // ✅ real API url
      document.getElementById("apiText").textContent = API;

      let playerToken = localStorage.getItem("cc_playerToken_" + ROOM) || "";
      let playerId = localStorage.getItem("cc_playerId_" + ROOM) || "";
      let hostToken = localStorage.getItem("cc_host_" + ROOM) || "";

      const elStatus = document.getElementById("status");
      const elBlack = document.getElementById("black");
      const elPhase = document.getElementById("phase");
      const elCzar = document.getElementById("czar");
      const elPlayers = document.getElementById("players");
      const elScores = document.getElementById("scores");
      const elHand = document.getElementById("hand");
      const elHandHint = document.getElementById("handHint");
      const elSubmitOut = document.getElementById("submitOut");
      const elMe = document.getElementById("me");
      const elMinPlayers = document.getElementById("minPlayers");
      const elJoinOut = document.getElementById("joinOut");
      const elJudgeCard = document.getElementById("judgeCard");
      const elSubs = document.getElementById("submissions");
      const elJudgeOut = document.getElementById("judgeOut");

      document.getElementById("copy").onclick = async () => {
        try {
          await navigator.clipboard.writeText(location.href);
          elStatus.textContent = "Link copied.";
        } catch {
          elStatus.textContent = "Couldn’t copy. Just copy the URL.";
        }
      };

      function headers() {
        const h = { "content-type": "application/json" };
        if (playerToken) h.authorization = "Bearer " + playerToken;
        if (hostToken) h["x-host-token"] = hostToken;
        return h;
      }

      async function apiGET(path) {
        const r = await fetch(API + path, { headers: headers() });
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      async function apiPOST(path, body) {
        const r = await fetch(API + path, {
          method: "POST",
          headers: headers(),
          body: JSON.stringify(body || {}),
        });
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}
        return { ok: r.ok, status: r.status, data, text };
      }

      function renderScores(scores) {
        if (!scores) { elScores.textContent = "—"; return; }
        let rows = [];
        if (Array.isArray(scores)) rows = scores;
        else rows = Object.entries(scores).map(([name, points]) => ({ name, points }));

        rows.sort((a,b) => (b.points||0) - (a.points||0));
        if (!rows.length) { elScores.textContent = "No points yet."; return; }

        elScores.innerHTML = rows
          .map(s => `<div class="scoreRow"><span>${escapeHtml(s.name)}</span><b>${s.points||0}</b></div>`)
          .join("");
      }

      function renderHand(hand, canPlay) {
        elHand.innerHTML = "";
        if (!Array.isArray(hand) || !hand.length) {
          elHand.innerHTML = `<div class="muted small">No hand yet. Join the room.</div>`;
          return;
        }

        hand.forEach((text) => {
          const btn = document.createElement("button");
          btn.className = "whiteCard";
          btn.innerHTML = `<div class="cardText">${escapeHtml(text)}</div>`;
          btn.disabled = !canPlay;
          btn.onclick = () => submitCard(text);
          elHand.appendChild(btn);
        });
      }

      function renderJudge(subs, canJudge) {
        elSubs.innerHTML = "";
        if (!Array.isArray(subs) || !subs.length) {
          elSubs.innerHTML = `<div class="muted small">Waiting for submissions…</div>`;
          return;
        }

        subs.forEach((s) => {
          const btn = document.createElement("button");
          btn.className = "whiteCard";
          btn.innerHTML = `<div class="cardText">${escapeHtml(s.text || "")}</div>`;
          btn.disabled = !canJudge;
          btn.onclick = () => judgePick(s.submissionId);
          elSubs.appendChild(btn);
        });
      }

      async function join() {
        const name = (document.getElementById("name").value || "").trim() || "Anonymous";
        elJoinOut.textContent = "Joining…";

        const res = await apiPOST(`/api/rooms/${ROOM}/join`, { name });
        if (!res.ok) {
          elJoinOut.textContent = res.data.error || `Join failed (${res.status})`;
          return;
        }

        playerToken = res.data.playerToken || "";
        playerId = res.data.playerId || "";
        localStorage.setItem("cc_playerToken_" + ROOM, playerToken);
        localStorage.setItem("cc_playerId_" + ROOM, playerId);

        elJoinOut.textContent = "Joined ✅";
        load();
      }

      async function submitCard(text) {
        if (!playerToken) { elSubmitOut.textContent = "Join first."; return; }
        elSubmitOut.textContent = "Submitting…";

        const res = await apiPOST(`/api/rooms/${ROOM}/submit`, { text });
        if (!res.ok) {
          elSubmitOut.textContent = res.data.error || `Submit failed (${res.status})`;
          return;
        }

        elSubmitOut.textContent = "Submitted ✅";
        load();
      }

      async function judgePick(submissionId) {
        elJudgeOut.textContent = "Picking…";

        const res = await apiPOST(`/api/rooms/${ROOM}/judge`, { submissionId });
        if (!res.ok) {
          elJudgeOut.textContent = res.data.error || `Judge failed (${res.status})`;
          return;
        }

        elJudgeOut.textContent = "Winner picked ✅";
        load();
      }

      async function load() {
        const res = await apiGET(`/api/rooms/${ROOM}`);
        if (!res.ok) {
          elStatus.textContent = res.data.error || `Room load failed (${res.status})`;
          elBlack.textContent = "—";
          return;
        }

        const room = res.data;
        const phase = room.phase || room.state || "unknown";

        elPhase.textContent = String(phase).toUpperCase();
        elBlack.textContent = room.blackCard || room.prompt || "—";
        elCzar.textContent = "Czar: " + (room.czarName || "—");

        const count = room.playerCount ?? (room.players ? Object.keys(room.players).length : 0);
        elPlayers.textContent = "Players: " + count;
        elMinPlayers.style.display = (count && count < 4) ? "block" : "none";

        const me = room.me || {};
        elMe.textContent = me.name ? `${me.name}${me.isCzar ? " (Czar)" : ""}` : "Not joined";

        renderScores(room.scores);

        const canPlay = !!playerToken && !me.isCzar && phase !== "judging" && count >= 4 && !me.hasSubmitted;
        elHandHint.textContent = me.isCzar
          ? "You’re the czar. Don’t play a card this round."
          : (me.hasSubmitted ? "You already submitted. Waiting on others…" : "Click a card to submit.");

        renderHand(room.hand, canPlay);

        const canJudge = !!playerToken && !!me.isCzar && phase === "judging";
        elJudgeCard.style.display = (me.isCzar ? "block" : "none");
        if (me.isCzar) renderJudge(room.submissions, canJudge);

        elStatus.textContent = "Updated.";
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m =>
          ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
        );
      }

      document.getElementById("join").onclick = join;

      load();
      setInterval(load, 2500);
    </script>

    <style>
      body{ margin:0; font-family:system-ui; background:#070a0f; color:#fff; }
      .wrap{ max-width:1100px; margin:30px auto; padding:0 18px; }

      .topline{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end; }
      .topBtns{ display:flex; gap:10px; flex-wrap:wrap; }

      .card{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:18px; border-radius:16px; margin:14px 0; }
      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

      .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      h1{ margin:0; }
      h2{ margin:0; font-size:18px; }

      .label{ font-weight:800; font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.65); }
      .black{
        margin-top: 8px;
        font-size: 20px;
        line-height: 1.35;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(0,0,0,.35);
      }

      .meta{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; min-width: 200px; }
      .warn{
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255,170,120,.28);
        background: rgba(255,170,120,.10);
        color: rgba(255,255,255,.92);
        font-size: 13px;
      }

      input{
        width:100%;
        box-sizing:border-box;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(0,0,0,.25);
        color:#fff;
        margin-top:10px;
      }

      .scores{ margin-top: 10px; display:flex; flex-direction:column; gap:6px; }
      .scoreRow{ display:flex; justify-content:space-between; gap:10px; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }

      .handGrid{
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(3, minmax(0,1fr));
        gap: 10px;
      }

      .whiteCard{
        text-align:left;
        cursor:pointer;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        padding: 12px;
        color:#fff;
        font-weight:700;
      }
      .whiteCard:hover{ border-color: rgba(9,255,3,.35); }
      .whiteCard:disabled{
        opacity:.55;
        cursor:not-allowed;
        border-color: rgba(255,255,255,.12);
      }
      .cardText{ font-weight:700; line-height:1.35; }

      .btn{
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(255,255,255,.05);
        color:#fff;
        font-weight:800;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .btn.primary{ border-color:rgba(9,255,3,.55); background:rgba(9,255,3,.14); }
      .btn.ghost{ background:rgba(255,255,255,.04); }

      .chip{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); font-size:12px; width: fit-content; }

      .muted{ color:rgba(255,255,255,.68); }
      .small{ font-size:13px; }
      .tiny{ font-size:12px; margin-top:12px; }
      .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

      @media(max-width:900px){
        .grid2{ grid-template-columns:1fr; }
        .handGrid{ grid-template-columns: 1fr; }
        .meta{ align-items:flex-start; }
      }
    </style>
  </body>
</html>
